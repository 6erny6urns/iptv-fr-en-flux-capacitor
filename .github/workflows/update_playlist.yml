name: Update IPTV Playlist

on:
  workflow_dispatch:   # Pour lancer manuellement

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Create output directory if missing
      run: mkdir -p playlist

    - name: Run stream validation script
      run: python generator/validate_streams.py

    - name: Commit and push filtered playlist
      env:
        TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add playlist/playlist_filtered.m3u validation_log.txt
        git commit -m "Automated playlist update with validated live streams" || echo "No changes to commit"
        git push https://x-access-token:${TOKEN}@github.com/6erny6urns/iptv-fr-en-flux-capacitor.git HEAD:main
